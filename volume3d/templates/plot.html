{% extends 'pagesbase.html' %}
{% block head %}
{{ super() }}
    <link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-0.12.0.min.css" type="text/css" />
    <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-0.12.0.min.js"></script>
    <script type="text/javascript">
      // monkry patch to handle broken Bokeh.safely() function in version 0.12.0
      var orgBokehSafely = Bokeh.Safely;
      Bokeh.safely = function(msg){
            msg();
      };
    </script>
{% endblock %}

{% block body %}
<h1>Plot Test</h1>
<div>
    <p id="alertMessage"></p>
</div>
<form id="filter" method="POST" action='#'>
    <div class="form-group form-group-sm">
        <div class="col-sm-1">
            <button type="button" id="plot" class="btn btn-primary">Plot</button>
        </div>
        <div class="col-sm-4">
            <input class="form-control" type="text" id="plotid">
        </div>
    </div>
</form>

<p>plotid </p>
<div><p id="log"></p></div>
<div><p id="bokehdiv"></p></div>
{% endblock %}

{% block js %}
  $(document).ready(function(){
    var ioroomid = '{{message.ioroomid}}';
    var plotid   = '01234';
    ///////////////////////////////
    function generateAlert(msg, type="success"){
      var words = '<div class="alert alert-' + type  + ' alert-dismissible">' +
                  '<button type="button" class="close" data-dismiss="alert">&times;</button> ' +
                   msg + '</div>';
            return words;
    }
    // load the javascript file
    function load(file) {
      var src = document.createElement("script");
      src.setAttribute("type", "text/javascript");
      src.setAttribute("src", file);
      document.getElementsByTagName("head")[0].appendChild(src);
    }
    ///////////////////////////////
      var namespace = '/test';
      // connect to the socket
      var endPoint = "http" + (self.location.protocol == "https:" ? "s" : "") +
                     "://"  + document.domain + ':' + location.port + namespace;
      var socket   = io.connect(endPoint);

      socket.on('connect', function() {
          socket.emit('my event', {sid: '40', data: 'I\'m connected!'});
          if (ioroomid !==""){
            console.log('join io room: ' + ioroomid);
            socket.emit('join', {room: ioroomid});
          }
      });
      socket.on('disconnect', function() {
          $('#log').append('<br>Disconnected');
      });
      socket.on('my response', function(msg) {
          $('#log').append('<br>Received: ' + msg.data);
      });

      socket.on('alert message', function(msg) {
          $('#alertMessage').append(generateAlert(msg.data));
      });

      $("#plot").click(function(event){
        // check if plotid exists
        var tid = $('#plotid').val() ||  plotid;
        socket.emit("plot request", {'dbid': tid});
        $('#log').append('Button clicked');
      });

      socket.on('plot available', function(msg){
        $('#alertMessage').append(generateAlert("plot is available"));
        load(msg['jsURL'])
        $("#bokehdiv").append(msg.div);
      });
  });
{% endblock %}
