{% extends 'pagesbase.html' %}

{% block body %}
<h1>Upload new File</h1>
    <p>{{message}}</p>
    <div><input type='file' accept='*.xrslog|text/plain' id="file_upload" class="inputfile" enctype="multipart/form-data"></div>

    <div class="progress">
      <div class="progress-bar" role="progressbar" aria-valuenow="70"
      aria-valuemin="0" aria-valuemax="100" style="width:0%">
        0%
      </div>
    </div>
    <div><p id="log"></p></div>
{% endblock %}

{% block js %}
$(document).ready(function(){
  $('.progress-bar').hide();
  var add = false;
  namespace = '/test';
  // connect to the socket : http://do
  var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
  socket.on('connect', function() {
      socket.emit('my event', {sid: socket.io.engine.id, data: 'I\'m connected! (' + socket.io.engine.id + ')'});
  });
  socket.on('disconnect', function() {
      $('#log').append('<br>Disconnected');
  });
  socket.on('my response', function(msg) {
      $('#log').append('<br>Message: ' + msg.data);
  });

  $('#file_upload1').on('change', function(event){
      console.log ('inside onchange().');

      var reader = new FileReader();
      reader.loadend = function(){
        $('#log').append('<br>Message: loadend event' );
      };
    });

    var t_readers=[];

    $('#file_upload').on('change', function(event){
        console.log ('inside onchange().');

        $('.progress-bar').prop("style", 'width:'+"0%");
        $('.progress-bar').text("0%");
        $('.progress-bar').show();

        var input  = event.target;
        var totalbytes = input.files[0].size;
        $('#log').append('<br>Message: blob size: ' + totalbytes);
        $('#log').append('<br>Message: blob size: ' + input.files[0].name);

        var reader    = new FileReader();
        var blockSize = 1024 * 1024 * 50;
        var numBlob   = Math.ceil(totalbytes/blockSize);
        var pid       = 0;
        reader.onprogress = function(evt) {
            if (evt.lengthComputable) {
                percentage = Math.floor(evt.loaded / evt.total * 100);
                $('.progress-bar').prop("style", 'width:'+percentage+"%");
                $('.progress-bar').text(percentage+"%");
            }
        };
        reader.loadend = function(){
          $('#log').append('<br>Message: loadend event' );
        };

        reader.onload = function(evt){
          $('#log').append('<br>Message: onload event' );
          if (numBlob == 1){
            $('#log').append('<br>Message: send data in 1 blob.' );
            socket.emit('file_upload', {name: input.files[0].name, size: input.files[0].size, data: evt.target.result, addToExistDb : add });
          }
          else {
            $('#log').append('<br>Message: send data in multiple blobs.' );
            }
            // emit complet signal
            //socket.emit('file_upload_completed', {sid: socket.io.engine.id, numBlob: numBlob});
          };

        if (numBlob == 1) {
          $('#log').append('<br>Message: uploading ... file size ' + input.files[0].size + ' bytes.' );
          reader.readAsArrayBuffer(input.files[0]);
          add = true;
        }
        else {
          $('#log').append('<br>Message: send data in multiple blobs.' );
          for (i = 0; i < numBlob; i++) {
            var t_reader    = new FileReader();
            t_readers.push(t_reader);
            $('#log').append('<br>Message: uploading ... file in parts ' + i );
            t_readers[i].onload = function(evt) {
              $('#log').append('<br>Message: send blob ' + pid );
              socket.emit('file_upload', {sid:socket.io.engine.id, name: input.files[0].name,
                                          numBlob: numBlob, blobId: pid++, size: input.files[0].size,
                                          data: evt.target.result, addToExistDb : add });
            };
            t_readers[i].readAsArrayBuffer(input.files[0].slice(i*blockSize,(i+1)*blockSize > totalbytes ? totalbytes : (i+1)*blockSize ))
          }
        }

    });
  });

{% endblock %}
